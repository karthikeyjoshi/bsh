name: Release BSH

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    
    strategy:
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            artifact_name: bsh-linux-x86_64
            install_deps: sudo apt-get update && sudo apt-get install -y ninja-build libgit2-dev pkg-config python3
          
          # Apple Silicon (M1/M2/M3)
          - os: macos-latest
            artifact_name: bsh-macos-arm64
            install_deps: brew install libgit2
            
          # Apple Intel Older Macs
          - os: macos-15-intel
            artifact_name: bsh-macos-x86_64
            install_deps: brew install libgit2

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: ${{ matrix.install_deps }}

      - name: Configure CMake
        run: cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build BSH Daemon
        run: cmake --build build --target bsh-daemon

      - name: Package Binary and Scripts
        run: |
          # Create a clean folder structure for the tarball
          mkdir -p bsh-release/bin
          mkdir -p bsh-release/scripts
          
          # Copy the compiled daemon and the Zsh hook
          cp build/bsh-daemon bsh-release/bin/
          cp scripts/bsh_init.zsh bsh-release/scripts/
          
          # Compress into a standard tar.gz archive
          tar -czvf ${{ matrix.artifact_name }}.tar.gz -C bsh-release .

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.artifact_name }}.tar.gz